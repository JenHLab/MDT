<!DOCTYPE html>
<!-- The code from Mike's block demo'ing US counties in topojson: https://bl.ocks.org/mbostock/4090848 -->
<meta charset="utf-8">
<head>

<link href='https://fonts.googleapis.com/css?family=Merriweather:400,400italic' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Amiri' rel='stylesheet' type='text/css'>

<style>

body {
  font-family: serif;
  font: 12px;
  padding: 10px;
  margin-top: 2px;
}

h1, h2 {
  font-family: 'Amiri', serif;
}
/* css for annual ridership line graph. For axis css see below stacked bar chart */
circle:hover {
        stroke: gray;
      }

.axis text {
        font-family: sans-serif;
        font-size: 11px;
      }

/*css for stacked bar chart */
#form {
      position: relative;
      right: 10px;
      top: 10px;
      padding-bottom: 20px;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.bar {
  fill: steelblue;
}

.x.axis path {
  display: none;
}

/* css for map svg*/
path {
  stroke: black;
  fill:none;
}

pathl {
stroke: black;
  fill:none;
  

}

circle {
  fill: orange;   
}

/* Style for Custom Tooltip for map svgs */
div.tooltip {
    position: absolute;
    text-align: left;
    min-width: 20px;
    height: 60px;
    padding: 2px;
    font: 12px sans-serif;
    background: #f2f2f2;
    border-radius: 5px;
    pointer-events: none;
}

.tooltip p {
    margin: 10px;
}


</style>
</head>
<body>

<h1>Miami-Dade Transit (MDT)</h1>
    <p>Miami-Dade Transit (MDT) operates the Metrobus, Metrorail, Metromover and Paratransit (STS). MDT is the largest transit system in Florida and provides an alternative to private vehicles to more than 2.5 million residents in the county. 
  <br><br>
    The Metrobus is the most popular MDT service.
</p>
  <h3>Total Annual Ridership in Miami-Dade County
  </h3>
  <div id="firstLineChart"></div>
  <p>Ridership starting declining in 2008 due to the effects of the recession and increase in unemployment.</p>
  <h3>Public Transportation Ridership Preferences in Miami-Dade County (October, 2015)
  </h3>
    <div id="form">
      <label><input type="radio" name="mode" value="bycount" checked><b>Total Ridership</b> (day of the week)</label>
      <label><input type="radio" name="mode" value="bypercent"><b>As Percent of Ridership Preferences</b></label>
    </div>
    <div id="chart"></div>

   <h2>Metrobus</h2> 
   <p>(METROBUS NFORMATION HERE, STATS, ETC.)
  <br><br>
    <h4>Metrobus Stations</h4>
      Hover each STOP to see the name of the metrobus station and address.
      <br>
      [PLACEHOLDER- map showing all metrorail stops; similar to Metromover map]
    </p> 
    <P>
      [PLACEHOLDER- annual individual bus route ridership, 2008-2015]
    </p>
  

  <h2>Metrorail</h2> 
   <p>(METRORAIL NFORMATION HERE, STATS, ETC.)
  <br><br>
    <h4>Metrorail Stations</h4>
      Hover each STOP to see the name of the metrorail station and address.
      <br>
      <div id="metrorailInfo"></div>
    </p>  
     <p>
      [PLACEHOLDER- annual ridership, 2008-2011]
    </p>



  <h2>Metromover</h2>
    <p>(METROMOVERI NFORMATION HERE, STATS, ETC.)
  <br><br>
    <h3>Metromover Stations</h3>
      Hover each STOP to see the name of the metromover station and address.
    </p>
<div id="metromoverInfo"></div>

<p>PLACEHOLDER- annual ridership, 2008-2011]</p>

<p style="font-size: 14px;">
  <b>Sources:</b> 
    <br>
  <a href="factfinder.census.gov"> American FactFinder</a>. US Census Bureau. 2016.
    <br>
  <a href="http://www.miamidade.gov/transit/home.asp"> Transportation and Public Works</a>. Miami-Dade County. 2016.
    <br>
    <a href="http://www.miamidade.gov/transit/reports-plans.asp"> Ridership Technical Reports</a>. Transportation and Public Workds. Miami-Dade County. 2016.
    <br>
    <a href="http://www.miamidade.gov/transit/reports-plans.asp"> Transportation</a>. Miami-Dade County GIS Open Data. Miami-Dade County. 2016.
    <br>
</p>
<script src="js/queue.v1.min.js"></script>
<script src="//d3js.org/d3.v3.min.js"></script>
<script src="//d3js.org/topojson.v1.min.js"></script>
<script type="text/javascript">



//Begin Line chart
queue()
  .defer(d3.csv, "data/annual_ridership.csv")
  .await(loadAnnual);

function loadAnnual(error, annualR) {
  if (error) throw error;

  var fullwidth = 700;
  var fullheight = 300;
  var margin = { top: 20, right: 10, bottom: 50, left: 100};

  var width = fullwidth - margin.left - margin.right;
  var height = fullheight - margin.top - margin.bottom;


//Set up date formatting and years
var dateFormat = d3.time.format("%Y");

var xScale = d3.time.scale()
                .range([ 0, width ]);

var yScale = d3.scale.linear()
                .range([ 0, height ]);

var xAxis = d3.svg.axis()
              .scale(xScale)
              .orient("bottom")
              .ticks(18)
              .tickFormat(function(d) {
                return dateFormat(d);
              });

var yAxis = d3.svg.axis()
              .scale(yScale)
              .orient("left");

var line = d3.svg.line()
        .x(function(d) {
          return xScale(dateFormat.parse(d.year));
        })
        .y(function(d) {
          return yScale(d.ridership);
        });

var tooltip = d3.select("body")
        .append("div")
        .attr("class", "tooltip");

var svg = d3.select("#firstLineChart")
            .append("svg")
            .attr("width", fullwidth)
            .attr("height", fullheight)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        // get the min and max of the years in the data, after parsing as dates!
xScale.domain(d3.extent(annualR, function(d){
            return dateFormat.parse(d.year);
            })
        );

        // the domain is from the max of the ridership to 0 - remember it's reversed.
yScale.domain([ d3.max(annualR, function(d) {
            return +d.ridership;
          }),
         75000000
        ]);

        //Line
        //

        // Lines take a single array of data as their input.  So we don't give it data(data).

        // you could do this:
        // .data([data])
        // or use the d3 "datum" which is for single data elements.

        svg.datum(annualR)
          .append("path")
          .attr("class", "line us")
          .attr("d", line)  // line is a function that will operate on the data array, with x and y.
          .attr("fill", "none")
          .attr("stroke", "steelblue")
          .attr("stroke-width", 1);

        // dots go on top of the line!

       var circles = svg.selectAll("circle")
                .data(annualR)
                .enter()
                .append("circle");

        circles.attr("cx", function(d) {
            return xScale(dateFormat.parse(d.year));
          })
          .attr("cy", function(d) {
            return yScale(d.ridership);
          })
          .attr("r", 3)
          .style("opacity", 0); // this is optional - if you want visible dots or not!


        circles
          .on("mouseover", mouseoverFunc)
          .on("mousemove", mousemoveFunc)
          .on("mouseout", mouseoutFunc);

        svg.append("g")
          .attr("class", "x axis")
          .attr("transform", "translate(0," + height + ")")
          .call(xAxis);

        svg.append("g")
          .attr("class", "y axis")
          .call(yAxis);


  function mouseoverFunc(d) {
    // Adding a subtle animation to increase the dot size when over it!
      d3.select(this)
        .transition()
        .duration(50)
        .style("opacity", 1)
        .attr("r", 7);
      tooltip
        .style("display", null) // this removes the display none setting from it
        .html("<p><b>Year:</b> " + d.year +
              "<br><b>Total:</b> " + d.ridership + " riders</p>");
      }

  function mousemoveFunc(d) {
      tooltip
        .style("top", (d3.event.pageY - 10) + "px" )
        .style("left", (d3.event.pageX + 10) + "px");
    }

  function mouseoutFunc(d) {
    // shrink it back down:
      d3.select(this)
        .transition()
        .style("opacity", 0)
        .attr("r", 3);
      tooltip.style("display", "none");  // this sets it to invisible!
    }

}; //end line chart

//Begin Stacked bar 
//queue to load 2+ data files.
queue()
  .defer(d3.csv, "data/total_ridership_2015.csv")
  .await(loadIntroGraph);

function loadIntroGraph(error, data) {
  if (error) throw error;

 data.sort(function(a, b) {return d3.ascending(a.City,b.City);});

var cities = ["Metrobus","Metrorail","Metromover","STS"];

var currentMode = "bycount";

var fullwidth = 500, fullheight = 300;

var margin = {top: 10, right: 170, bottom: 80, left: 80},
    width = fullwidth - margin.left - margin.right,
    height = fullheight - margin.top - margin.bottom;

var xScale = d3.scale.ordinal()
    .rangeRoundBands([0, width], .3);

var yScale = d3.scale.linear()
    .rangeRound([height, 0]);

var color = d3.scale.category20();

var xAxis = d3.svg.axis()
    .scale(xScale)
    .orient("bottom")
    .innerTickSize([0]);

var yAxis = d3.svg.axis()
    .scale(yScale)
    .orient("left")
    .tickFormat(d3.format(".2s")); // for the stacked totals version

var stack = d3.layout
    .stack(); // default view is "zero" for the count display.

var svg = d3.select("#chart").append("svg")
    .attr("width", fullwidth)
    .attr("height", fullheight)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var tooltip = d3.select("body").append("div").attr("class", "tooltip");

color.domain(cities);

  xScale.domain(data.map(function(d) { return d.City; }));

  svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis)
      .selectAll("text")
        .attr("dy", ".5em")
        .attr("transform", "rotate(-30)")
        .style("text-anchor", "end");

  svg.append("g")
      .attr("class", "y axis")
      .call(yAxis)
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("Ridership");

  transitionCount(); // this will use the by-count stack, and make the data, and draw.

  drawLegend();

  d3.selectAll("input").on("change", handleFormClick);

  function handleFormClick() {
    if (this.value === "bypercent") {
      currentMode = "bypercent";
      transitionPercent();
    } else {
      currentMode = "bycount";
      transitionCount();
    }
  }


  function makeData(cities, data) {
    return cities.map(function(city) {
        return data.map(function(d) {
          return {x: d.City, y: +d[city], city: city};
        })
      });
  }


  function transitionPercent() {

    yAxis.tickFormat(d3.format("%"));
    stack.offset("expand");  // use this to get it to be relative/normalized!
    var stacked = stack(makeData(cities, data));
    // call function to do the bars, which is same across both formats.
    transitionRects(stacked);
  }

  function transitionCount() {

    yAxis.tickFormat(d3.format(".2s")); // for the stacked totals version
    stack.offset("zero");
    var stacked = stack(makeData(cities, data));
    transitionRects(stacked);

    }

  function transitionRects(stacked) {

    // this domain is using the last of the stacked arrays, which is the last city, and getting the max height.
    yScale.domain([0, d3.max(stacked[stacked.length-1], function(d) { return d.y0 + d.y; })]);

    var city = svg.selectAll("g.city")
      .data(stacked);

    city.enter().append("g")
      .attr("class", "city")
      .style("fill", function(d, i) { return color(d[0].city); });

  // then data for each, plus mouseovers - a nested selection/enter here
   city.selectAll("rect")
      .data(function(d) {
        console.log("array for a rectangle", d);
        return d; })  // this just gets the array for bar segment.
    .enter().append("rect")
      .attr("width", xScale.rangeBand())
      .on("mouseover", mouseover)
      .on("mousemove", mousemove)
      .on("mouseout", mouseout);

    // the thing that needs to transition is the rectangles themselves, not the g parent.
    city.selectAll("rect")
      .transition()
      .duration(250)
      .attr("x", function(d) {
        return xScale(d.x); })
      .attr("y", function(d) {
        return yScale(d.y0 + d.y); }) //
      .attr("height", function(d) {
        return yScale(d.y0) - yScale(d.y0 + d.y); });  // height is base - tallness

    city.exit().remove(); // there's actually nothing removed here - we just transition.

    svg.selectAll(".y.axis").transition().call(yAxis);
  }

  function drawLegend() {

    // reverse to get the same order as the bar color layers
    var cities_reversed = cities.slice().reverse();

    var legend = svg.selectAll(".legend")
        .data(cities_reversed) // make sure your labels are in the right order -- if not, use .reverse() here.
      .enter().append("g")
        .attr("class", "legend")
        .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

    legend.append("rect")
        .attr("x", width)
        .attr("width", 18)
        .attr("height", 18)
        .style("fill", function(d) {return color(d)});

    legend.append("text")
        .attr("x", width + 24)
        .attr("y", 9)
        .attr("dy", ".35em")
        .style("text-anchor", "start")
        .text(function(d, i) { return cities_reversed[i].replace(/_/g, " "); });
  }

  function mouseover(d) {
  // this will highlight both a dot and its line.

  var number;

  d3.select(this)
    .transition()
    .style("stroke", "black");

  if (currentMode == "bypercent") {
    number = d3.format(".1%")(d.y);
  } else {
    number = d.y;
  }

  tooltip
    .style("display", null) // this removes the display none setting from it
    .html("<p><b>Mode of Public Transportation:</b> " + d.city.replace(/_/g, " ") +
          "<br><b>Ridership:</b> " + number +
          "<br><b>Day of the Week:</b> " + d.x + " </p>");
  }

  function mousemove(d) {
    tooltip
      .style("top", (d3.event.pageY - 10) + "px" )
      .style("left", (d3.event.pageX + 10) + "px");
    }

  function mouseout(d) {
    d3.select(this)
      .transition()
      .style("stroke", "none");

    tooltip.style("display", "none");  // this sets it to invisible!
  }

}; //end stacked bar;

//Begin metromover station map
queue()
  .defer(d3.json, "data/dade.json")
  .defer(d3.csv, "data/Metromover_Stations.csv") // process
  .await(loaded);

function loaded(error, dadeM, metromover) {
  if (error) throw error;

  //global variables for map svgs for bus, metrorail and metromover stations
var width = 310,
    height = 400;

var projection = d3.geo.conicEqualArea()
      .parallels([31,85])
      .rotate([81, 0])
      .center([0, 28])
      .translate([-6250,-18400])
      .scale(490000);

var path = d3.geo.path()
    .projection(projection);

  //Declare metrorailsvg and append it to metrorailInfo div
  var metromoversvg = d3.select("#metromoverInfo").append("svg")
                        .attr("width", width)
                        .attr("height", height);

  // Append Div for tooltip to metrorailsvg
  var div = d3.select("#metromoverInfo")
              .append("div")
              .attr("class", "tooltip")
              .style("display", "none");


  //Append map to metrorailsvg to plot the lat and lon of metrorail stations
  metromoversvg.selectAll("path.state")
              .data(topojson.feature(dadeM, dadeM.objects.dade).features)
              .enter().append("path")
              .attr("d", path);

  //Append circles to show metrorail stations and append tooltip    
  metromoversvg.selectAll("circle")
        .data(metromover)
        .enter()
        .append("circle")
        .attr("cx", function(d) {
            return projection([d.lon, d.lat])[0];
        })
        .attr("cy", function(d) {
            return projection([d.lon, d.lat])[1];
        })
        .attr("r", 3)
                       .style("fill", function(d) {
                         var returnColor;
                         if (d === 1) { returnColor = "green";
                         } else if (d === 2) { returnColor = "purple";
                         } else if (d === 3) { returnColor = "red"; }
                         return returnColor;
                      })
        .on("mouseover", function(d) {
            div.transition()
               .duration(200)
               .style("display", null);
            div.html("<p><b>Stop Name:</b> " + d.name+ "<br> <b>Address:</b> " + d.address+ "<br> <b> Loop:</b> " + d.loop)
               .style("left", (d3.event.pageX + 10) + "px")
               .style("top", (d3.event.pageY - 28) + "px");
        })
        // fade out tooltip on mouse out
        .on("mouseout", function(d) {
            div.transition()
               .duration(500)
               .style("display", "none");
        });
      
}; // end loaded for metromover station map;

//begin metrorail station map;
queue()
  .defer(d3.json, "data/dade.json")
  .defer(d3.csv, "data/Metrorail_Stations.csv") // process
  .await(loadedRail);

function loadedRail(error, dadeM, metrorail) {
  if (error) throw error;

  var width = 310,
    height = 400;

var projection = d3.geo.conicEqualArea()
      .parallels([31,85])
      .rotate([81, 0])
      .center([0, 28])
      .translate([-700,-2540])
      .scale(71500);

var path = d3.geo.path()
    .projection(projection);

  //Declare metrorailsvg and append it to metrorailInfo div
  var metrorailsvg = d3.select("#metrorailInfo").append("svg")
                        .attr("width", width)
                        .attr("height", height);

  // Append Div for tooltip to metrorailsvg
  var div = d3.select("#metrorailInfo")
              .append("div")
              .attr("class", "tooltip")
              .style("display", "none");


  //Append map to metrorailsvg to plot the lat and lon of metrorail stations
  metrorailsvg.selectAll("path.state")
              .data(topojson.feature(dadeM, dadeM.objects.dade).features)
              .enter().append("path")
              .attr("d", path);

  //Append circles to show metrorail stations and append tooltip    
  metrorailsvg.selectAll("circle")
        .data(metrorail)
        .enter()
        .append("circle")
        .attr("cx", function(d) {
            return projection([d.lon, d.lat])[0];
        })
        .attr("cy", function(d) {
            return projection([d.lon, d.lat])[1];
        })
        .attr("r", 3)
        .on("mouseover", function(d) {
            div.transition()
               .duration(200)
               .style("display", null);
            div.html("<p><b>Stop Name:</b> " + d.name+ "<br> <b>Address:</b> " + d.address+ "<br> <b> Parking spaces:</b> " + d.parking)
               .style("left", (d3.event.pageX + 10) + "px")
               .style("top", (d3.event.pageY - 28) + "px");
        })
        // fade out tooltip on mouse out
        .on("mouseout", function(d) {
            div.transition()
               .duration(500)
               .style("display", "none");
        });
      
};

</script>
</body>
</html>